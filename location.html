<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=2">
<title>HTMLGPS 0.0.1</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/openlocationcode/1.0.4/openlocationcode.min.js" integrity="sha512-nNdmCJgFefLPn6W79uEUxH2n4+qbc0kJM8uBD8f7GlmusrQN9L13hpSBRxLHdLs+6oSDurcCuDlBXVKaz/hpcA==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/nosleep/0.11.0/NoSleep.min.js" integrity="sha512-z2nddjNLcxjIKYaNqKfpwgl+8mFVU4gTL8afldQukUIOKYgFbD2TyDCyAFlCKuWoLhEJ49zpEnzLDiPMXKJ1kQ==" crossorigin="anonymous"></script>
<script src="vincenty.js"></script>
<script>
const softwareVersionString=`HTMLGPS v0.0.1 [${navigator.userAgent}] - https://www.github.com/JamesTheAwesomeDude/HTMLGPS`

var tripLog;

function _main(){
	tripLog=new TripLog();
	applyLanguagePrefs();
	geo.watchPosition(pos=>{
		//openTripLogSegment(tripLog);
		updateUserDisplays(pos);
		tripLog.update(pos);
	 },
	 err=>{
		invalidateUserDisplays();
		//closeTripLogSegment(tripLog);
		tripLog.offerToSave();
	 }
	);
	enableNoSleep();
}

function main(event){//body.onload=='main(event);'
	_main();
}

class TripLog {
 constructor(){
	this.date=new Date();
	this.entries=[];
 }

 update(pos){
	this.entries.push(pos);
 }

 vibeCheck(){
	let numberOfZeroEles=this.entries.reduce(
	 (n,pos)=>(
	  n+(pos.coords.altitude==0.0)
	 ),
	 0
	);
	if(numberOfZeroEles>Math.sqrt(this.entries.length)){
		this.entries.forEach(pos=>{
			delete pos.coords.altitude;
		});
	}
 }

 offerToSave(container=document.getElementById('tripLogLinkWrapper')){
	this.vibeCheck();
	let payload=TripLog.renderPayload(this);
	let a=document.createElement('a');
	let fname=`trip_${getYYYYMMDDHHMM()}.gpx`;
	a.href=renderBlobURL(payload,fname,{type:'text/xml'});
	a.download=fname;
	a.textContent=fname;
	a.onclick=ev=>setTimeout(e=>(
	 URL.revokeObjectURL(
	  e.parentNode.removeChild(e)
	  .href
	 )
	),0,ev.target);
	container.appendChild(a);
 }

 static renderPrettyDistance(tripLog,unit='miles'){
	return '[TODO]';
 }

 static renderPayload(tripLog){
	let payload=[];
	payload.push(
`<?xml version="1.0"?>
<gpx
 version="1.0"
creator="${softwareVersionString}"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xmlns="http://www.topografix.com/GPX/1/0"
xsi:schemaLocation="http://www.topografix.com/GPX/1/0
http://www.topografix.com/GPX/1/0/gpx.xsd">
<time>${tripLog.date.toISOString()}</time>
`
	);
	
	payload.push(
`<trk><name>${escapeText(prompt('What do you want to name this trace?') || 'test run')}</name>
<trkseg>
` //TODO: multi-segments based on when the page lost focus
	);
	tripLog.entries.forEach(pos=>{
		let lat=pos.coords.latitude;
		let lon=pos.coords.longitude;
		let ele=pos.coords.altitude;
		let time=(new Date(pos.timestamp)).toISOString();
		payload.push(
`<trkpt lat="${lat}" lon="${lon}">${
ele?`  <ele>${ele}</ele>
`:''}
<time>${time}</time>
</trkpt>
`
		);
	});
	payload.push(
`</trkseg>
</trk>
`
	);
	payload.push(
`</gpx>`
	);
	
	return payload;
 }
}

const geo=navigator.geolocation;
const unitConversions={
 'm/s':   1,
 'mph':   2.236936292054402,
 'km/h':  3.6,
 'm':     1,
 'km':    1e-3,
 'miles': 6.213711922373339e-4
}

function updateUserDisplays(pos){
	let lat=pos.coords.latitude;
	let lon=pos.coords.longitude;
	let speed=pos.coords.speed;
	let heading=pos.coords.heading;
	//let course=getCourse(tripLog,pos);
	let accuracy=pos.coords.accuracy;
	let ele=pos.coords.altitude;
	let eleAccuracy=pos.coords.altitudeAccuracy;
	
	let speedEl=document.getElementById('speed');
	let locationEl=document.getElementById('location');
	let distanceEl=document.getElementById('distance');
	
	speedEl.textContent=renderPrettySpeed(pos.coords.speed,speedEl.getAttribute('data-unit'));// + renderPrettyBearing(tripLog,pos)
	locationEl.textContent=renderPrettyCoords(lat,lon);
	distanceEl.textContent=TripLog.renderPrettyDistance(tripLog,distanceEl.getAttribute('data-unit'));
}

function renderPrettySpeed(speed,unit='mph'){
	if(isNaN(speed)) return '???';
	return (speed*unitConversions[unit]).toFixed(1)+unit;
}

function renderPrettyCoords(lat,long){
	return OpenLocationCode.encode(lat,long,OpenLocationCode.CODE_PRECISION_EXTRA).slice(4);
}

function enableNoSleep(){
	document.addEventListener('click', function enableNoSleep() {
		document.removeEventListener('click', enableNoSleep, false);
		noSleep.enable();
	}, false);
}

function getYYYYMMDDHHMM(d=new Date()){
	const pad=s=>('0'+s).slice(('0'+s).length-2);
	return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}${pad(d.getHours())}${pad(d.getMinutes())}`;
}

function escapeText(s){
	let e=document.createElement('p');
	e.textContent=s;
	return e.innerHTML;
}

function renderBlobURL(data,fname,properties){// ht- https://stackoverflow.com/a/32295448/1874170
	let file;
	try {
		file = new File(data, fname, properties);
	} catch(e) {
		file = new Blob(data, properties);
	}
	return URL.createObjectURL(file);
}

function enableNoSleep(){
	const noSleep = new NoSleep();
	document.addEventListener('click', function enableNoSleep() {
		document.removeEventListener('click', enableNoSleep, false);
		noSleep.enable();
	}, false);
}

function applyLanguagePrefs(){
	const lang=navigator.language;
	
	let speedEl=document.getElementById('speed');
	let distanceEl=document.getElementById('distance');
	
	if(lang.match('US')){
		speedEl.setAttribute('data-unit','mph');
		distanceEl.setAttribute('data-unit','miles');
	} else {
		speedEl.setAttribute('data-unit','km/h');
		distanceEl.setAttribute('data-unit','m');
	}
}

</script>
<style>
.telemetryDisplayWrapper {
	text-align: center;
}

#speed {
	font-size: xx-large;
	font-weight: bold;
}
#location {
	font-size: x-large;
}
#distance {
	font-size: large;
}
</style>
</head>
<body onload="main();">
<div class="telemetryDisplayWrapper">
<p id="speedWrapper">Speed: <span id="speed">…</span></p>
<p id="locationWrapper">Location: <span id="location">…</span></p>
<p id="distanceWrapper">Distance Traveled: <span id="distance">…</span><br /><button onclick="tripLog.offerToSave();">Save Trip Log</button></p>
</div>
<p id="tripLogLinkWrapper"></p>
</body>
</html>
