<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=2">
<title>HTMLGPS 0.0.2</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/openlocationcode/1.0.4/openlocationcode.min.js" integrity="sha512-nNdmCJgFefLPn6W79uEUxH2n4+qbc0kJM8uBD8f7GlmusrQN9L13hpSBRxLHdLs+6oSDurcCuDlBXVKaz/hpcA==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/nosleep/0.11.0/NoSleep.min.js" integrity="sha512-z2nddjNLcxjIKYaNqKfpwgl+8mFVU4gTL8afldQukUIOKYgFbD2TyDCyAFlCKuWoLhEJ49zpEnzLDiPMXKJ1kQ==" crossorigin="anonymous"></script>
<script src="https://www.ishygddt.xyz/~james/vincenty.js" integrity="sha512-+OH160Itw1ie77AV3FhD60ZTZN9fbMsBI+/03kNOGxXzgEnf7EPb+tc2Q3CeSzGzS1SZyetTix/eGx/jWuT4jQ==" crossorigin="anonymous"></script>
<script>
const softwareVersionString=`${document.querySelector('title').textContent} [${navigator.userAgent}] - https://www.github.com/JamesTheAwesomeDude/HTMLGPS`

var tripLog;

function _main(){
	tripLog=new TripLog();
	applyLanguagePrefs();
	geo.watchPosition(pos=>{
		//openTripLogSegment(tripLog);
		updateUserDisplays(pos);
		tripLog.update(pos);
	 },
	 err=>{
		alert(`Error is allegedly:\n\n${err.message}`);
		invalidateUserDisplays();
		//closeTripLogSegment(tripLog);
		tripLog.offerToSave();
	 },
	 {enableHighAccuracy: true}
	);
}

function main(event){//body.onload=='main(event);'
	_main();
}

class TripLog {
 constructor(){
	this.date=new Date();
	this.entries=[new Array()];
 }

 get currentSegment() {return this.entries.slice(-1)[0]};

 incrementSegment(){
	this.entries.push(new Array());
 }

 update(pos){
	let t=pos.timestamp;
	let d1t,d2t;
	if(this.currentSegment.length>1){
		d1t=t-this.currentSegment.slice(-1)[0].timestamp;
		d2t=t-d1t-this.currentSegment.slice(-2)[0].timestamp;
		if( d1t > Math.E*d2t ){
			this.incrementSegment();
		}
	}
	this.currentSegment.push(pos);
 }

 vibeCheck(){
	let numberOfZeroEles=0;
	let numberOfTrkpts=0;
	this.entries.forEach(
	 segment=>segment.forEach(
	  pos=>{
	  	numberOfTrkpts++;
	  	numberOfZeroEles+=(pos.coords.altitude==0.0);
	  }
	 )
	);
	if(numberOfZeroEles>Math.sqrt(numberOfTrkpts)){
	 this.entries.forEach(
	  segment=>segment.forEach(
	   pos=>{
	   	delete pos.coords.altitude;
	   }
	  )
	 );
	}
 }

 offerToSave(container=document.getElementById('tripLogLinkWrapper')){
	this.vibeCheck();
	let payload=TripLog.renderPayload(this);
	let a=document.createElement('a');
	let fname=`trip_${getYYYYMMDDHHMM()}.gpx`;
	a.href=renderBlobURL(payload,fname,{type:'text/xml'});
	a.download=fname;
	a.textContent=fname;
	a.onclick=ev=>setTimeout(e=>(
	 URL.revokeObjectURL(
	  e.parentNode.removeChild(e)
	  .href
	 )
	),0,ev.target);
	container.appendChild(a);
 }

 static renderPrettyDistance(tripLog,unit='miles'){
	return '[TODO]';
 }

 static renderPayload(tripLog){
	let payload=[];
	payload.push(
`<?xml version="1.0"?>
<gpx
 version="1.0"
creator="${softwareVersionString}"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xmlns="http://www.topografix.com/GPX/1/0"
xsi:schemaLocation="http://www.topografix.com/GPX/1/0
http://www.topografix.com/GPX/1/0/gpx.xsd">
<time>${tripLog.date.toISOString()}</time>
`
	);
	
	payload.push(
`<trk><name>${escapeText(prompt('What do you want to name this trace?','test run'))}</name>
` //TODO: multi-segments based on when the page lost focus
	);
	tripLog.entries.forEach(segment=>{
		payload.push(
`<trkseg>
`
		);
		segment.forEach(pos=>{
			let lat=pos.coords.latitude;
			let lon=pos.coords.longitude;
			let ele=pos.coords.altitude;
			let time=(new Date(pos.timestamp)).toISOString();
			payload.push(
`<trkpt lat="${lat}" lon="${lon}">${
ele?`  <ele>${ele}</ele>`:''}
<time>${time}</time>
</trkpt>
`
			);		
		});
		payload.push(
`</trkseg>
`
		);
	});
	payload.push(
`</trk>
`
	);
	payload.push(
`</gpx>`
	);
	
	return payload;
 }
}

const geo=navigator.geolocation;
const unitConversions={
 'm/s':   1,
 'mph':   2.236936292054402,
 'km/h':  3.6,
 'm':     1,
 'km':    1e-3,
 'miles': 6.213711922373339e-4
}

function updateUserDisplays(pos){
	let lat=pos.coords.latitude;
	let lon=pos.coords.longitude;
	let speed=pos.coords.speed;
	let heading=pos.coords.heading;
	//let course=getCourse(tripLog,pos);
	let accuracy=pos.coords.accuracy;
	let ele=pos.coords.altitude;
	let eleAccuracy=pos.coords.altitudeAccuracy;
	
	let speedEl=document.getElementById('speed');
	let locationEl=document.getElementById('location');
	let locationUncertaintyEl=document.getElementById('locU');
	let distanceEl=document.getElementById('distance');
	
	speedEl.textContent=renderPrettySpeed(pos.coords,speedEl.getAttribute('data-unit'));// + renderPrettyBearing(tripLog,pos)
	locationEl.textContent=renderPrettyCoords(pos.coords);
	locationUncertaintyEl.textContent='±∓'[tripLog.currentSegment.length%2]+`${accuracy.toFixed(1)}m`;
	distanceEl.textContent=TripLog.renderPrettyDistance(tripLog,distanceEl.getAttribute('data-unit'));
}

function renderPrettySpeed(coords,unit='mph'){
	if(isNaN(coords.speed)) return '???';
	return (coords.speed*unitConversions[unit]).toFixed(1)+unit+(coords.speed<Math.sqrt(coords.accuracy) ? '?' : '');
}

function renderPrettyCoords(coords){
	let lat=coords.latitude;
	let lon=coords.longitude;
	if(coords.accuracy<8){
		return OpenLocationCode.encode(lat,lon,OpenLocationCode.CODE_PRECISION_EXTRA ).slice(4);
	} else {
		return OpenLocationCode.encode(lat,lon,OpenLocationCode.CODE_PRECISION_NORMAL).slice(4);
	}
}

function getYYYYMMDDHHMM(d=new Date()){
	const pad=s=>('0'+s).slice(('0'+s).length-2);
	return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}${pad(d.getHours())}${pad(d.getMinutes())}`;
}

function escapeText(s){
	let e=document.createElement('p');
	e.textContent=s;
	return e.innerHTML;
}

function renderBlobURL(data,fname,properties){// ht- https://stackoverflow.com/a/32295448/1874170
	let file;
	try {
		file = new File(data, fname, properties);
	} catch(e) {
		file = new Blob(data, properties);
	}
	return URL.createObjectURL(file);
}

function enableNoSleepButton(event){
	window.noSleep = new NoSleep();
	window.noSleep.enable();
	event.target.setAttribute('onclick','disableNoSleepButton(event);');
	event.target.textContent="Resume intermittency";
}
function disableNoSleepButton(event){
	window.noSleep.disable();
	delete window.noSleep;
	event.target.setAttribute('onclick','enableNoSleepButton(event);');
	event.target.textContent="Keep screen awake";
}

function applyLanguagePrefs(){
	const lang=navigator.language;
	
	let speedEl=document.getElementById('speed');
	let distanceEl=document.getElementById('distance');
	
	if(lang.match('US')){
		speedEl.setAttribute('data-unit','mph');
		distanceEl.setAttribute('data-unit','miles');
	} else {
		speedEl.setAttribute('data-unit','km/h');
		distanceEl.setAttribute('data-unit','m');
	}
}

</script>
<style>
.telemetryDisplayWrapper {
	text-align: center;
}

#speed {
	font-size: xx-large;
	font-weight: bold;
}
#location {
	font-size: x-large;
}
#distance {
	font-size: large;
}
[onclick^="enableNoSleepButton"] {
	box-shadow: 0 0 1em 1pt orange;
}
</style>
</head>
<body onload="main();">
<div class="telemetryDisplayWrapper">
<p id="speedWrapper">Speed: <span id="speed">…</span></p>
<p id="locationWrapper">Location: <span id="location">…</span><spad id="locU"></span></p>
<p id="distanceWrapper">Distance Traveled: <span id="distance">…</span><br /><button onclick="tripLog.offerToSave();">Save Trip Log</button></p>
</div>
<p id="tripLogLinkWrapper"></p>
<p><br /><button onclick="enableNoSleepButton(event);">Keep screen awake</button></p>
</body>
</html>
